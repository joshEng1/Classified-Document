version: "3.8"
services:
  docling:
    build: ./docling-service
    ports:
      - "7000:7000"
    environment:
      - EXTRACT_PIPELINE=docling_cli
      - DOCLING_CLI=docling
      - DOCLING_TO=md
      - DOCLING_PIPELINE=standard
      - DOCLING_OCR_MODE=auto
      - DOCLING_OCR=1
      - DOCLING_TABLES=0
      - DOCLING_IMAGE_EXPORT_MODE=placeholder
      # Optional backend for PDFs (uncomment to override)
      # - DOCLING_PDF_BACKEND=pypdfium2
    restart: unless-stopped
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    ports:
      - "5055:5055"
    environment:
      - PORT=5055
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5055,http://127.0.0.1:5055}
      - CORS_ALLOW_NULL=${CORS_ALLOW_NULL:-false}
      - CORS_ALLOW_ALL=${CORS_ALLOW_ALL:-false}
      - TRUST_PROXY=${TRUST_PROXY:-true}
      - MODEL_MODE_DEFAULT=${MODEL_MODE_DEFAULT:-online}
      - PUBLIC_API_RATE_LIMIT_ENABLED=${PUBLIC_API_RATE_LIMIT_ENABLED:-true}
      - PUBLIC_API_RATE_LIMIT_WINDOW_MS=${PUBLIC_API_RATE_LIMIT_WINDOW_MS:-60000}
      - PUBLIC_API_RATE_LIMIT_MAX_REQUESTS=${PUBLIC_API_RATE_LIMIT_MAX_REQUESTS:-8}
      - PUBLIC_API_RATE_LIMIT_METHODS=${PUBLIC_API_RATE_LIMIT_METHODS:-POST}
      - PUBLIC_API_RATE_LIMIT_PATHS=${PUBLIC_API_RATE_LIMIT_PATHS:-/api/process,/api/process-stream,/api/process-batch,/api/pdf/session,/api/pdf/render-pages,/api/pdf/redact}
      - API_NO_STORE=${API_NO_STORE:-true}
      - VERBOSE_SERVER_LOGS=${VERBOSE_SERVER_LOGS:-false}
      - LLAMA_DEBUG=${LLAMA_DEBUG:-false}
      - UPLOAD_RETENTION_MINUTES=${UPLOAD_RETENTION_MINUTES:-120}
      - UPLOAD_CLEANUP_INTERVAL_MINUTES=${UPLOAD_CLEANUP_INTERVAL_MINUTES:-15}
      - VERIFIER_ENGINE=${VERIFIER_ENGINE:-openai}
      - ONLINE_PROVIDER=${ONLINE_PROVIDER:-gemini}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-3-flash-preview}
      - GEMINI_SUMMARY_MODEL=${GEMINI_SUMMARY_MODEL:-gemini-3-flash-preview}
      - GEMINI_MODERATION_MODEL=${GEMINI_MODERATION_MODEL:-gemini-3-flash-preview}
      - GEMINI_PII_MODEL=${GEMINI_PII_MODEL:-gemini-3-flash-preview}
      - GEMINI_TIMEOUT_MS=${GEMINI_TIMEOUT_MS:-45000}
      - GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY}
      - GOOGLE_CLOUD_ACCESS_TOKEN=${GOOGLE_CLOUD_ACCESS_TOKEN}
      - CLOUD_VISION_SAMPLE_MAX_PAGES=${CLOUD_VISION_SAMPLE_MAX_PAGES:-2}
      - CLOUD_VISION_SAMPLE_DPI=${CLOUD_VISION_SAMPLE_DPI:-120}
      - CLOUD_VISION_OBJECT_THRESHOLD=${CLOUD_VISION_OBJECT_THRESHOLD:-0.55}
      - CLOUD_VISION_TIMEOUT_MS=${CLOUD_VISION_TIMEOUT_MS:-20000}
      - CLOUD_VISION_ANNOTATE_BATCH_SIZE=${CLOUD_VISION_ANNOTATE_BATCH_SIZE:-4}
      - CLOUD_VISION_MAX_INFLIGHT=${CLOUD_VISION_MAX_INFLIGHT:-2}
      - CLOUD_VISION_RENDER_DPI=${CLOUD_VISION_RENDER_DPI:-150}
      - CLOUD_VISION_OCR_MAX_PAGES=${CLOUD_VISION_OCR_MAX_PAGES:-0}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OFFLINE_MODE=${OFFLINE_MODE:-false}
      # In Docker Desktop (Windows/macOS), use host.docker.internal to reach host-run llama.cpp servers
      - LLAMA_URL=${LLAMA_URL:-http://host.docker.internal:8080}
      - SLM_URL=${SLM_URL:-http://host.docker.internal:8080}
      - GUARDIAN_URL=${GUARDIAN_URL:-http://host.docker.internal:8081}
      - GUARDIAN_MODEL=${GUARDIAN_MODEL:-granite-guardian-3.2-3b-a800m}
      - VISION_URL=${VISION_URL:-http://host.docker.internal:8082}
      - VISION_MODEL=${VISION_MODEL:-granite-vision-3.2-2b}
      - VISION_ENABLE=${VISION_ENABLE:-true}
      - VISION_IMAGE_COVERAGE_THRESHOLD=${VISION_IMAGE_COVERAGE_THRESHOLD:-0.25}
      - VISION_FIGURE_COUNT_THRESHOLD=${VISION_FIGURE_COUNT_THRESHOLD:-1}
      - VISION_MIN_TEXT_CHARS_WITH_FIGURES=${VISION_MIN_TEXT_CHARS_WITH_FIGURES:-200}
      - VISION_CROP_FIGURES=${VISION_CROP_FIGURES:-true}
      - VISION_MAX_REGIONS_PER_PAGE=${VISION_MAX_REGIONS_PER_PAGE:-3}
      - VISION_MIN_REGION_AREA_PCT=${VISION_MIN_REGION_AREA_PCT:-0.03}
      - VISION_MIN_TOTAL_REGION_AREA_PCT=${VISION_MIN_TOTAL_REGION_AREA_PCT:-0.15}
      - VISION_RENDER_DPI=${VISION_RENDER_DPI:-220}
      - VISION_MAX_PAGES=${VISION_MAX_PAGES:-12}
      # Docling is another container on the default compose network
      - DOCLING_URL=http://docling:7000
      - ROUTE_LOW=${ROUTE_LOW:-0.5}
      - AUTO_ACCEPT=${AUTO_ACCEPT:-0.9}
      - LOCAL_CLASSIFIER=${LOCAL_CLASSIFIER:-heuristic}
      - VERIFY_SECOND_PASS=${VERIFY_SECOND_PASS:-true}
      - LOCAL_DEFAULT_CONF=${LOCAL_DEFAULT_CONF:-0.92}
      - REDACT_OUTPUT_PDF=${REDACT_OUTPUT_PDF:-true}
    depends_on:
      - docling
    restart: unless-stopped
